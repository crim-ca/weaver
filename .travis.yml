language: python
os:
  - linux
#  - osx
python:
  - "2.7"
  - "3.5"
  - "3.6"
  - "3.7"
  - "3.8"
env:
  global:
  - secure: j7fuAPDXdl0SF1My1f0e3hr8mq4idP41jsz98Y1hN30GGOmIputScxIwSjIBi8zFCJ+K4RleMIoWLhnFsMeMD4DapRqDe5YnJJFOyfiyplzEcn4yONYRJf1nzfXBrpoGSEibgr/e3uYK62bkantI+b0pBPNAKbRjbRKKwTKEAxWb1pfaAMEQMB8/Wmvo0XYAZRB96H4q/7Dtd4CaIqh99Fs/9TjaGdNNtDtjwL0AWPXNfamsA8oNW0frNp1lEYpJpRE+PHFiKWZWyrRqjDA/UNU2UE/2H1O53I6tUXGJjORrUGRp1M9Xq/NhC8C4l7KrdpYH7YkYdvRDts3+XmJZ5kCsGB35YLP8DF1yUXIL4ZMskegBsBKqKKgnXGo4uYkaHp0QR2r8v2tdO8q3JWGYLSCgGVu5YkHU6Nlqf98W5LQLYSuZEkLplrk9vISHNS6TI4G3m7huToY1HwOu01hTZHAEhr/ouUxOfu6pQs8ZYVCyj98o65KFlFCRa7qKHc2/lXVbFPaOeQmFYqCGfFMTB0G0DHlsyOJk3QzoTr0HxJlbEwh9XLJOAnGO/TwcOUZndlj0+lTuCTpeBhjHywr+b00HnYtJ3cVnUVjT8TZydG2ATogeKRvOe0m58ug36EUGwbjr0JoN2hHjeFNSdvTUzFFFmRBY9rps47rzEDyRBGc=
  - secure: jtK2GwC2Z97r1LdZpqDoj7UGVbTq9Dk+CdXXRbrWuSFCc/SA/TFFeEaHJHm1V0oVFeC5YVpu2B7Z/Di71SmqF/tafArLuDF5LCFegddZBlG372xaKn/ilfLRriA9dyb/yopmnRInqh9ynd1/CokNFjMAKuj4bZYJZImL7nsY9iCdAfuv51thQg2Nd4oj50SiR9MSgEhxOsdos5CncJqSbJrw9KEJGpz69ZtOD6p6UVfd8PgCaDSRuU/RaTAZLLFznRW4+OcUyOy1KXkmEyo7YoF6D/OJvS5INYvACk3/5o5qNYA7YJh6MfQbHd0Y9qvjGO6jvPRikNWhbo4pvCDNx37A5B9BdvUQFpP1T1SdBGCWdfF9qDvskw95kryh/fbs5YTd6rjQUGlQ9Qzt7eJFUd3SpasZRviqcHHyGCJtTqOw0ow6rMYmk2dSDoAi+/H6DDxuZc/a0K+s9U/fCDGCUCee2IyD8zz1CoG+BKO66rVHN1eeuOKlaDzmG6gPLcTbOCcP/jlM/KlBTQO2vzUvc7k0tBb9NunLXSV2eu5zXPyyVbCsKkc2wCNKO40Hsmx9+lALmS4LVlxNBHcNmdHWYiSIOVH2yhM7Ud1/Wsj2NVjzd2KJ5WAuO85cegn3r1o+VtsFNr8YeFdiNCyYETgfxs3OoLnhG/wN++oxXGeXXpQ=
  - secure: BZBVvKMZaMuMBq3LvdwpBEnyk2OO9yDu+Izxqvoba3/QT2zD0lA8bOFFUYErjuhKecmda1OyNnjdejs2wpGxEEal21AR/BoNHeVTH7euaQzjhWo9MaBnnpFqsKABxy4EFdHZHGD90LrrFoCj7HgI4w+BxABQSsdSuWNYHl4oCyAF9TsPnKGFIlW0HlAR32rxaWHjuxVtxLkiws2GJbyjA3EDSJb7vB5pfnJPTaLTPkgZpAWHa8cGQoXQrZdfG0an7dg3GdPKPc75N0piVqnpEDK89wCpjSK5AwYrsjcc5E1cjJiab9XNopZDLxQzWf8+u455TrSAvcZNkev5o/qg1hbHqnUkOoMvGbipyyNxu0/dzElesRYQ7673fGT/yiZDd7re9qUz31HFIDC5TUfMPoVs0NMX+lNHEDy9FH5UvVV8udTVAJPw5+7vjzd3CpMIGWHt9Syk6OwU1BxdHIeielrlfK7YMkgXQe69KcLKwIdg5QaF7l4I0EtDQ4Ra5d/N36uyLejBIZ7laOgl1IAO9zUXoEtvEI7mcivvWAOSdV6FblG5U4K+/27d3FxRmO06KuIVaYEbPp2HWeVaJADxqTVpRp5bUZ8aEGWihI4L74UbHXWRUPkHt4AG16Ubb/hTrYnCCKL3pvUMFBU5/LoJeyjCVGgi0WOFBaJJazl3XyI=
cache:
  - pip
  - directories:
      - $HOME/conda
      - $HOME/downloads
# includes PR when base branch = master
if: branch = master OR tag IS present
services:
  - mongodb
before_install:
  - source tests/travis-ci/weaver.env
  - cp -f tests/travis-ci/custom.cfg ./
  - cp -f tests/travis-ci/data_sources.json ./
  - make --version
  - make info
install:
  - make install
  - make start
before_script:
  - sleep 5
script:
  # run static analysis only once
  - |
    if [ "${TRAVIS_PYTHON_VERSION}" == "3.7" ]; then
      make check
      make coverage
      make docs
    fi
  # run tests for each python version
  - make test
matrix:
  allow_failures:
    - os: osx
    - python: "2.7"   # deprecated support
    - python: "3.8"   # experimental packages
notifications:
  email: false
after_success:
  - bash <(curl -s https://codecov.io/bash) || echo "Codecov did not collect coverage reports"
  - source $(HOME)/conda/bin/activate weaver && python-codacy-coverage -r reports/coverage.xml
after_script:
  - make stop
  - |
    if [ "$TRAVIS_BRANCH" == "master" ];
    then export TAG_VERSION=latest;
    else export TAG_VERSION=$TRAVIS_TAG;
    fi
  - |
    if [ "${TRAVIS_PYTHON_VERSION}" == "3.7" ]; then
      if [ -z "${TAG_VERSION}" ] || [ "$TRAVIS_PULL_REQUEST" == "false" ];
      then echo "Nothing to build for '$TRAVIS_BRANCH' (PR: $TRAVIS_PULL_REQUEST)";
      else make APP_VERSION=$TAG_VERSION docker-info docker-build docker-push;
      fi
    fi
